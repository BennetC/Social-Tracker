{% extends "base.html" %}

{% block title %}Edit Event - Social Tracker{% endblock %}

{% block head %}
    <link rel="stylesheet" href="{{ url_for('static', filename='form_styles.css') }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='add_event.css') }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='modals.css') }}">
{% endblock %}

{% block header_nav %}{% endblock %}

{% block content %}
<div class="form-page-container">
    <div class="form-header">
        <h1><i class="fas fa-edit"></i> Edit Event</h1>
        <p>Refining the details for: {{ event.title }}</p>
    </div>

    <div class="form-container">
        <form method="POST" action="{{ url_for('edit_event', event_id=event.id) }}">
            <!-- Event Details Section -->
            <div class="form-section">
                <h2 class="section-title">Event Details</h2>
                <div class="form-group">
                    <label for="title">Event Title *</label>
                    <input type="text" id="title" name="title" required value="{{ event.title or '' }}">
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label for="start_date">Start Date</label>
                        <input type="date" id="start_date" name="start_date" value="{{ event.start_date.strftime('%Y-%m-%d') if event.start_date else '' }}">
                    </div>
                    <div class="form-group">
                        <label for="end_date">End Date</label>
                        <input type="date" id="end_date" name="end_date" value="{{ event.end_date.strftime('%Y-%m-%d') if event.end_date else '' }}">
                    </div>
                </div>
                <div class="form-group">
                    <label for="priority">Priority</label>
                    <select id="priority" name="priority">
                        {% for p in priorities %}<option value="{{ p }}" {% if event.priority == p %}selected{% endif %}>{{ p }}</option>{% endfor %}
                    </select>
                </div>
                <div class="form-group">
                    <label for="details">Additional Details</label>
                    <textarea id="details" name="details" rows="5" placeholder="Describe the event, goals, locations, etc.">{{ event.details or '' }}</textarea>
                </div>
            </div>

            <!-- Status Section -->
            <div class="form-section">
                <h2 class="section-title">Status</h2>
                <div class="checklist-item">
                    <input type="checkbox" name="is_potential" id="is_potential" {% if event.is_potential %}checked{% endif %} onchange="togglePotentialFields()">
                    <label for="is_potential">This is a tentative/potential event</label>
                </div>
                <div id="potential-fields" style="display: {% if event.is_potential %}block{% else %}none{% endif %}; margin-top: 20px;">
                    <div class="form-row">
                        <div class="form-group">
                            <label for="pros">Pros</label>
                            <textarea id="pros" name="pros" rows="4" placeholder="Potential benefits or upsides...">{{ event.pros or '' }}</textarea>
                        </div>
                        <div class="form-group">
                            <label for="cons">Cons</label>
                            <textarea id="cons" name="cons" rows="4" placeholder="Potential risks or downsides...">{{ event.cons or '' }}</textarea>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Participants Section -->
            <div class="form-section">
                <h2 class="section-title">Participants</h2>
                <div id="selected-participants-container" class="selected-pills-container"></div>
                <div id="participant-ids-inputs"></div>
                <button type="button" id="manageParticipantsBtn" class="btn-secondary-outline">
                    <i class="fas fa-users"></i> Manage Participants
                </button>
            </div>

            <!-- Follow-Up Section (Conditional) -->
            {% if (event.end_date and event.end_date < now) or (not event.end_date and event.start_date and event.start_date < now) %}
            <div class="form-section">
                <h2 class="section-title">Follow-Up & Analysis</h2>
                <div class="form-group">
                    <label for="outcome">Outcome</label>
                    <textarea id="outcome" name="outcome" rows="4" placeholder="What was the result of the event?">{{ event.outcome or '' }}</textarea>
                </div>
                <div class="form-group">
                    <label for="learnings">Key Learnings</label>
                    <textarea id="learnings" name="learnings" rows="4" placeholder="What were the key takeaways?">{{ event.learnings or '' }}</textarea>
                </div>
            </div>
            {% endif %}

            <div class="submit-section">
                <button type="submit" class="btn-primary">Save Changes</button>
                <a href="{{ url_for('get_event', event_id=event.id) }}" class="btn-secondary">Cancel</a>
            </div>
        </form>
    </div>
</div>

<!-- Participant Selection Modal -->
<div id="participants-modal" class="modal-overlay" style="display:none;">
    <div class="modal-content">
        <div class="modal-header">
            <h2>Select Participants</h2>
            <button type="button" class="close-modal-btn">×</button>
        </div>
        <div class="modal-body">
            <div class="filter-controls">
                <input type="text" id="participant-search" placeholder="Search by name...">
                <select id="priority-filter">
                    <option value="">All Priorities</option>
                    {% for p in priorities %}<option value="{{ p }}">{{ p }}</option>{% endfor %}
                </select>
                <select id="tag-filter">
                    <option value="">All Tags</option>
                    {% for tag in tags %}<option value="{{ tag.id }}">{{ tag.name }}</option>{% endfor %}
                </select>
                <select id="ctype-filter">
                    <option value="">All Connection Types</option>
                    {% for ctype in connection_types %}<option value="{{ ctype.id }}">{{ ctype.name }}</option>{% endfor %}
                </select>
            </div>
            <div id="modal-participants-list" class="modal-results-list"></div>
        </div>
        <div class="modal-footer">
            <button type="button" class="btn-primary close-modal-btn">Done</button>
        </div>
    </div>
</div>

<script>
    function togglePotentialFields() {
        const checkbox = document.getElementById('is_potential');
        const fields = document.getElementById('potential-fields');
        fields.style.display = checkbox.checked ? 'block' : 'none';
    }

    document.addEventListener('DOMContentLoaded', () => {
        const modal = document.getElementById('participants-modal');
        const openBtn = document.getElementById('manageParticipantsBtn');
        const closeBtns = modal.querySelectorAll('.close-modal-btn');
        const searchInput = document.getElementById('participant-search');
        const priorityFilter = document.getElementById('priority-filter');
        const tagFilter = document.getElementById('tag-filter');
        const ctypeFilter = document.getElementById('ctype-filter');
        const resultsList = document.getElementById('modal-participants-list');
        const selectedContainer = document.getElementById('selected-participants-container');
        const hiddenInputsContainer = document.getElementById('participant-ids-inputs');

        let selectedParticipants = {{ selected_participants_data|tojson|safe }};

        const renderSelectedPills = () => {
            selectedContainer.innerHTML = '';
            hiddenInputsContainer.innerHTML = '';
            selectedParticipants.forEach(p => {
                const pill = document.createElement('span');
                pill.className = 'pill';
                pill.innerHTML = `${p.name} <span class="remove-pill" data-id="${p.id}">×</span>`;
                selectedContainer.appendChild(pill);

                const hiddenInput = document.createElement('input');
                hiddenInput.type = 'hidden';
                hiddenInput.name = 'participant_ids';
                hiddenInput.value = p.id;
                hiddenInputsContainer.appendChild(hiddenInput);
            });
        };

        const toggleParticipant = (participant) => {
            const index = selectedParticipants.findIndex(p => p.id === participant.id);
            if (index > -1) {
                selectedParticipants.splice(index, 1);
            } else {
                selectedParticipants.push(participant);
            }
            renderSelectedPills();
            renderModalList(window.currentModalList || []);
        };

        const renderModalList = (participants) => {
            window.currentModalList = participants;
            resultsList.innerHTML = '';
            if (participants.length === 0) {
                resultsList.innerHTML = '<p class="empty-state">No relationships found.</p>';
                return;
            }
            participants.forEach(p => {
                const isSelected = selectedParticipants.some(sp => sp.id === p.id);
                const item = document.createElement('div');
                item.className = `modal-list-item ${isSelected ? 'selected' : ''}`;
                item.innerHTML = `<span>${p.name}</span><i class="fas ${isSelected ? 'fa-check-circle' : 'fa-plus-circle'}"></i>`;
                item.addEventListener('click', () => toggleParticipant(p));
                resultsList.appendChild(item);
            });
        };

        const fetchRelationships = async () => {
            const q = searchInput.value;
            const priority = priorityFilter.value;
            const tag_id = tagFilter.value;
            const ctype_id = ctypeFilter.value;
            const url = `/api/relationships/search?q=${q}&priority=${priority}&tag_id=${tag_id}&ctype_id=${ctype_id}`;

            try {
                const response = await fetch(url);
                const data = await response.json();
                renderModalList(data);
            } catch (error) {
                console.error("Failed to fetch relationships:", error);
                resultsList.innerHTML = '<p class="empty-state">Error loading data.</p>';
            }
        };

        let debounceTimer;
        searchInput.addEventListener('input', () => {
            clearTimeout(debounceTimer);
            debounceTimer = setTimeout(fetchRelationships, 300);
        });
        [priorityFilter, tagFilter, ctypeFilter].forEach(el => el.addEventListener('change', fetchRelationships));

        openBtn.addEventListener('click', () => {
            modal.style.display = 'flex';
            fetchRelationships();
        });
        closeBtns.forEach(btn => btn.addEventListener('click', () => modal.style.display = 'none'));

        selectedContainer.addEventListener('click', e => {
            if (e.target.classList.contains('remove-pill')) {
                const id = e.target.dataset.id;
                toggleParticipant({ id });
            }
        });

        renderSelectedPills();
    });
</script>
{% endblock %}